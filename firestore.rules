rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se o usuário é o dono do documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Obtém os dados do usuário atual
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Verifica se o usuário pertence à família
    function belongsToFamily(familyId) {
      return isAuthenticated() && getUserData().familyId == familyId;
    }
    
    // Verifica se o usuário é admin da família
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }
    
    // Verifica se o usuário é admin da família específica
    function isAdminOfFamily(familyId) {
      return belongsToFamily(familyId) && isAdmin();
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Leitura: Apenas o próprio usuário ou membros da mesma família
      allow read: if isOwner(userId) || 
                     (isAuthenticated() && belongsToFamily(resource.data.familyId));
      
      // Criação: Apenas o próprio usuário pode criar seu perfil
      allow create: if isOwner(userId) && 
                       request.resource.data.uid == userId;
      
      // Atualização: Apenas o próprio usuário ou admin da família
      allow update: if isOwner(userId) || 
                       (isAuthenticated() && 
                        isAdminOfFamily(resource.data.familyId) &&
                        // Admin pode alterar role, mas não pode se auto-rebaixar
                        (request.resource.data.role != 'dependent' || userId != request.auth.uid));
      
      // Exclusão: Apenas o próprio usuário
      allow delete: if isOwner(userId);
    }
    
    // ============================================
    // FAMILIES COLLECTION
    // ============================================
    match /families/{familyId} {
      // Leitura: Membros da família
      allow read: if belongsToFamily(familyId);
      
      // Criação: Qualquer usuário autenticado pode criar uma família
      allow create: if isAuthenticated() && 
                       request.resource.data.createdBy == request.auth.uid;
      
      // Atualização: Apenas admin da família
      allow update: if isAdminOfFamily(familyId);
      
      // Exclusão: Apenas o criador da família
      allow delete: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid;
    }
    
    // ============================================
    // TASKS COLLECTION
    // ============================================
    match /tasks/{taskId} {
      // Leitura: 
      // - Tarefas privadas: apenas o criador
      // - Tarefas normais: membros da família
      allow read: if isAuthenticated() && (
                     // Private tasks: only creator can read
                     (resource.data.isPrivate == true && resource.data.createdBy == request.auth.uid) ||
                     // Non-private tasks: family members can read
                     (resource.data.isPrivate != true && belongsToFamily(resource.data.familyId))
                   );
      
      // Criação: Membros da família
      allow create: if isAuthenticated() && 
                       belongsToFamily(request.resource.data.familyId) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.familyId == getUserData().familyId;
      
      // Atualização: 
      // - Admin pode atualizar qualquer tarefa da família (exceto privadas de outros)
      // - Usuário pode atualizar suas próprias tarefas
      allow update: if isAuthenticated() && 
                       belongsToFamily(resource.data.familyId) &&
                       (
                         // User can update their own tasks
                         resource.data.createdBy == request.auth.uid ||
                         // Admin can update non-private tasks
                         (isAdminOfFamily(resource.data.familyId) && resource.data.isPrivate != true)
                       );
      
      // Exclusão (Soft Delete): 
      // - Admin pode deletar tarefas não-privadas
      // - Usuário pode deletar suas próprias tarefas
      allow update: if isAuthenticated() && 
                       belongsToFamily(resource.data.familyId) &&
                       request.resource.data.deletedAt != null &&
                       (
                         resource.data.createdBy == request.auth.uid ||
                         (isAdminOfFamily(resource.data.familyId) && resource.data.isPrivate != true)
                       );
      
      // Hard Delete: Apenas criador ou admin (para tarefas não-privadas)
      allow delete: if isAuthenticated() &&
                       (resource.data.createdBy == request.auth.uid ||
                        (isAdminOfFamily(resource.data.familyId) && resource.data.isPrivate != true));
    }
    
    // ============================================
    // APPROVALS COLLECTION
    // ============================================
    match /approvals/{approvalId} {
      // Leitura: Membros da família
      allow read: if isAuthenticated() && 
                     belongsToFamily(resource.data.familyId);
      
      // Criação: Membros da família podem criar solicitações
      allow create: if isAuthenticated() && 
                       belongsToFamily(request.resource.data.familyId) &&
                       request.resource.data.requestedBy == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      // Atualização: Apenas admin pode aprovar/rejeitar
      allow update: if isAdminOfFamily(resource.data.familyId) &&
                       // Só pode mudar o status
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']) &&
                       // Status deve ser approved ou rejected
                       (request.resource.data.status == 'approved' || 
                        request.resource.data.status == 'rejected');
      
      // Exclusão: Apenas admin ou o solicitante pode deletar
      allow delete: if isAuthenticated() && 
                       (isAdminOfFamily(resource.data.familyId) || 
                        resource.data.requestedBy == request.auth.uid);
    }
    
    // ============================================
    // CATEGORIES COLLECTION (se existir)
    // ============================================
    match /categories/{categoryId} {
      // Leitura: Membros da família
      allow read: if isAuthenticated() && 
                     belongsToFamily(resource.data.familyId);
      
      // Criação: Membros da família
      allow create: if isAuthenticated() && 
                       belongsToFamily(request.resource.data.familyId);
      
      // Atualização: Apenas admin
      allow update: if isAdminOfFamily(resource.data.familyId);
      
      // Exclusão: Apenas admin
      allow delete: if isAdminOfFamily(resource.data.familyId);
    }
    
    // ============================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================
    // Qualquer outra coleção não especificada é bloqueada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
